<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GST Workview - Compliance AI Expert</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            margin: 0;
            font-family: 'Inter', sans-serif;
            background: #f5f7fa;
        }

        /* ===== LAYOUT ===== */
        .app-layout {
            display: flex;
            height: 100vh;
            padding-top: 70px;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 250px;
            min-width: 250px;
            background: #ffffff;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            padding: 1rem 0;
        }

        .sidebar-nav {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .sidebar-item {
            position: relative;
        }

        .sidebar-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1.25rem;
            color: #374151;
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            user-select: none;
        }

        .sidebar-link:hover {
            background: #f0f4ff;
            color: #1E3A8A;
        }

        .sidebar-link.active {
            background: #EBF0FF;
            color: #EB6711;
            border-left-color: #EB6711;
            font-weight: 600;
        }

        .sidebar-link .link-icon {
            width: 20px;
            text-align: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .sidebar-link .link-text {
            flex: 1;
        }

        .sidebar-link .chevron {
            font-size: 0.65rem;
            transition: transform 0.25s ease;
            color: #9ca3af;
        }

        .sidebar-link.expanded .chevron {
            transform: rotate(90deg);
        }

        /* Sub-menu */
        .sidebar-submenu {
            list-style: none;
            margin: 0;
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: #fafbfc;
        }

        .sidebar-submenu.open {
            max-height: 300px;
        }

        .sidebar-submenu li a {
            display: block;
            padding: 0.55rem 1.25rem 0.55rem 3.25rem;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.84rem;
            font-weight: 450;
            transition: all 0.15s ease;
        }

        .sidebar-submenu li a:hover,
        .sidebar-submenu li a.active {
            color: #EB6711;
            background: #FFF7ED;
        }

        .sidebar-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 0.5rem 1rem;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 2.5rem;
            background: #f8fafc;
        }

        .content-section {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* workflow styles */
        .workflow-container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            padding: 2.5rem;
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        .wf-step {
            display: none;
        }

        .wf-step.active {
            display: block;
            animation: fadeIn 0.4s ease-out;
        }

        .wf-header {
            margin-bottom: 2rem;
        }

        .wf-header h2 {
            font-size: 1.5rem;
            color: #111827;
            margin-bottom: 0.5rem;
        }

        .wf-header p {
            color: #6b7280;
            font-size: 0.95rem;
        }

        .cat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
        }

        .cat-btn {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

        .cat-btn:hover {
            border-color: #EB6711;
            background: #fffaf5;
        }

        .cat-btn.selected {
            border-color: #EB6711;
            background: #fff7ed;
            box-shadow: 0 0 0 2px rgba(235, 103, 17, 0.1);
        }

        .cat-btn .icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .cat-btn .title {
            font-weight: 700;
            color: #374151;
            display: block;
            margin-bottom: 0.25rem;
        }

        .cat-btn .desc {
            font-size: 0.8rem;
            color: #6b7280;
            line-height: 1.4;
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.4rem;
        }

        .form-group input {
            width: 100%;
            padding: 0.65rem;
            border: 1.5px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .form-group input:focus {
            border-color: #EB6711;
            outline: none;
        }

        .wf-footer {
            margin-top: auto;
            padding-top: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
        }

        .result-amount {
            font-size: 2.25rem;
            font-weight: 800;
            color: #1E3A8A;
            margin: 0.5rem 0;
        }

        .result-label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        .formula-hint {
            font-size: 0.75rem;
            color: #94a3b8;
            font-style: italic;
            margin-top: 1rem;
        }

        .btn-wf {
            padding: 0.6rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-wf-primary {
            background: #EB6711;
            color: #fff;
        }

        .btn-wf-primary:hover {
            background: #d45a0f;
        }

        .btn-wf-outline {
            background: transparent;
            border: 1.5px solid #d1d5db;
            color: #4b5563;
        }

        .btn-wf-outline:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .btn-wf:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
        }

        .upload-zone:hover {
            border-color: #EB6711;
            background: #fffaf5;
        }

        .upload-zone .icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .upload-zone .text {
            font-size: 0.8rem;
            color: #6b7280;
            line-height: 1.3;
        }

        .upload-zone .text strong {
            color: #374151;
            font-weight: 700;
        }

        .file-list-wf {
            margin-top: 1.5rem;
        }

        .file-item-wf {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8fafc;
            padding: 0.6rem 0.8rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            border: 1px solid #e2e8f0;
        }

        .file-item-wf .name {
            color: #374151;
            font-weight: 500;
        }

        .file-item-wf .remove {
            color: #ef4444;
            cursor: pointer;
            font-weight: 700;
            margin-left: 1rem;
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }



        /* ===== SECTION HEADER ===== */
        .section-header {
            margin-bottom: 2rem;
        }

        .section-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #1E3A8A;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin: 0 0 0.35rem 0;
        }

        .section-header .section-subtitle {
            color: #6b7280;
            font-size: 0.95rem;
            margin: 0;
        }

        /* ===== CATEGORY HEADER ===== */
        .category-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 2rem 0 0.35rem 0;
        }

        .category-header h2 {
            font-size: 1.15rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .category-header .cat-icon {
            font-size: 1.15rem;
        }

        .category-subtitle {
            color: #EB6711;
            font-size: 0.85rem;
            font-weight: 500;
            margin: 0 0 1rem 0;
        }

        /* ===== TOOL CARDS GRID ===== */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1rem;
        }

        .tool-card {
            background: #fff;
            border: 1.5px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.25s ease;
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .tool-card:hover {
            border-color: #EB6711;
            box-shadow: 0 4px 16px rgba(235, 103, 17, 0.10);
            transform: translateY(-2px);
        }

        .card-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 0.75rem;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #EBF0FF;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: #1E3A8A;
        }

        .card-badge {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            background: #FFF7ED;
            color: #EB6711;
            border: 1px solid #FDBA74;
        }

        .card-badge.sales {
            background: #F0F4FF;
            color: #1E3A8A;
            border-color: #93C5FD;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 0.4rem 0;
        }

        .card-desc {
            font-size: 0.84rem;
            color: #6b7280;
            line-height: 1.5;
            margin: 0 0 1.25rem 0;
            flex: 1;
        }

        .card-action {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            font-size: 0.85rem;
            font-weight: 600;
            color: #374151;
            padding: 0.5rem 1rem;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #fff;
            text-decoration: none;
            width: fit-content;
        }

        .card-action:hover {
            border-color: #EB6711;
            color: #EB6711;
            background: #FFF7ED;
        }

        /* ===== COMING SOON OVERLAY ===== */
        .coming-soon-card {
            position: relative;
            opacity: 0.55;
            pointer-events: none;
        }

        .coming-soon-tag {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #9ca3af;
            background: #f3f4f6;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }

        /* ===== NOTICE MANAGEMENT SECTION ===== */
        .notice-empty {
            text-align: center;
            padding: 4rem 2rem;
            color: #9ca3af;
        }

        .notice-empty .empty-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
        }

        .notice-empty h3 {
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        /* ===== GST REFUND DASHBOARD ===== */
        .refund-stats {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            border: 1px solid #e5e7eb;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
            margin-bottom: 0.35rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1E3A8A;
        }

        .stat-value.orange {
            color: #EB6711;
        }

        .stat-value.green {
            color: #16a34a;
        }

        /* ===== REPORTS SECTION ===== */
        .report-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .report-item {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .report-item:hover {
            border-color: #EB6711;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .report-icon {
            font-size: 1.5rem;
        }

        .report-info {
            flex: 1;
        }

        .report-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .report-desc {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .report-arrow {
            color: #d1d5db;
            font-size: 1.25rem;
        }

        /* ===== TOOLS SECTION ===== */
        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }

        .tool-tile {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tool-tile:hover {
            border-color: #1E3A8A;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(30, 58, 138, 0.08);
        }

        .tool-tile .tile-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .tool-tile .tile-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .tool-tile .tile-desc {
            font-size: 0.78rem;
            color: #9ca3af;
        }

        /* ===== DROPDOWN (navbar) ===== */
        .navbar-profile {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .nav-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 200px;
            display: none;
            padding: 0.5rem 0;
            z-index: 9999;
            margin-top: 0.5rem;
        }

        .nav-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 0.75rem 1.5rem;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .dropdown-item:hover {
            background: #f9fafb;
            color: #1E3A8A;
        }

        .dropdown-divider {
            height: 1px;
            background: #f3f4f6;
            margin: 0.5rem 0;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 900px) {
            .sidebar {
                width: 60px;
                min-width: 60px;
            }

            .sidebar .link-text,
            .sidebar .chevron,
            .sidebar-submenu {
                display: none;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <div style="display: flex; align-items: center; gap: 2rem;">
                <a href="clients.html" id="back-btn" class="logo"
                    style="text-decoration: none; display: flex; align-items: center; gap: 0.75rem;">
                    <div class="logo-icon"
                        style="background: #1E3A8A; color: white; padding: 4px 10px; border-radius: 6px; font-weight: 800;">
                        CE</div>
                    <span id="nav-client-name" style="font-weight: 700; color: #1E3A8A; font-size: 1.1rem;">Compliance
                        AI Expert</span>
                </a>
                <div style="height: 24px; width: 1px; background: #d1d5db;"></div>
                <h3 id="nav-service-name" style="color: #1f2937; font-size: 1rem;">GST REFUND</h3>
            </div>
            <div class="navbar-profile" onclick="toggleProfileDropdown(event)">
                <div style="display:flex; align-items:center; gap:0.75rem">
                    <div class="user-avatar-small" id="nav-avatar"
                        style="width:32px; height:32px; background:#1E3A8A; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-size:14px;">
                        C</div>
                </div>
                <div class="nav-dropdown" id="profile-dropdown">
                    <a href="profile.html" class="dropdown-item">
                        <span>üë§</span> My Profile
                    </a>
                    <a href="integrations.html" class="dropdown-item">
                        <span>üîå</span> Integrations
                    </a>
                    <div class="dropdown-divider"></div>
                    <div onclick="logout()" class="dropdown-item" style="color: #EF4444;">
                        <span>üö™</span> Logout
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="app-layout">
        <!-- ===== LEFT SIDEBAR ===== -->
        <aside class="sidebar">
            <ul class="sidebar-nav">
                <!-- Dashboard -->
                <li class="sidebar-item">
                    <a class="sidebar-link" data-section="dashboard" onclick="navigateTo('dashboard', this)">
                        <span class="link-icon">üìä</span>
                        <span class="link-text">Dashboard</span>
                    </a>
                </li>

                <!-- Notice Management -->
                <li class="sidebar-item">
                    <a class="sidebar-link" data-section="notice" onclick="navigateTo('notice', this)">
                        <span class="link-icon">üîî</span>
                        <span class="link-text">Notice Management</span>
                    </a>
                </li>

                <!-- GST Refund (expandable) -->
                <li class="sidebar-item">
                    <a class="sidebar-link" onclick="toggleSubmenu(this)">
                        <span class="link-icon">üí∞</span>
                        <span class="link-text">GST Refund</span>
                        <span class="chevron">‚ñ∂</span>
                    </a>
                    <ul class="sidebar-submenu" id="sub-gst-refund">
                        <li><a onclick="navigateTo('refund-dashboard', this)" data-section="refund-dashboard">Refund
                                Dashboard</a></li>
                        <li><a onclick="navigateTo('calculate-refund', this)" data-section="calculate-refund">Calculate
                                GST Refund</a></li>
                        <li><a onclick="navigateTo('know-refund', this)" data-section="know-refund">Know Your GST
                                Refund</a></li>
                        <li><a onclick="navigateTo('track-request', this)" data-section="track-request">Track
                                Request</a></li>
                    </ul>
                </li>

                <!-- GST Returns (expandable) -->
                <li class="sidebar-item">
                    <a class="sidebar-link" onclick="toggleSubmenu(this)">
                        <span class="link-icon">üìã</span>
                        <span class="link-text">GST Returns</span>
                        <span class="chevron">‚ñ∂</span>
                    </a>
                    <ul class="sidebar-submenu" id="sub-gst-returns">
                        <li><a onclick="navigateTo('gstr1', this)" data-section="gstr1">GSTR-1</a></li>
                        <li><a onclick="navigateTo('gstr3b', this)" data-section="gstr3b">GSTR-3B</a></li>
                    </ul>
                </li>

                <!-- Reports -->
                <li class="sidebar-item">
                    <a class="sidebar-link" data-section="reports" onclick="navigateTo('reports', this)">
                        <span class="link-icon">üìÑ</span>
                        <span class="link-text">Reports</span>
                    </a>
                </li>

                <!-- GST Reconciliation -->
                <li class="sidebar-item">
                    <a class="sidebar-link active" data-section="reconciliation"
                        onclick="navigateTo('reconciliation', this)">
                        <span class="link-icon">‚öñÔ∏è</span>
                        <span class="link-text">GST Reconciliation</span>
                    </a>
                </li>

                <!-- Tools -->
                <li class="sidebar-item">
                    <a class="sidebar-link" data-section="tools" onclick="navigateTo('tools', this)">
                        <span class="link-icon">üõ†Ô∏è</span>
                        <span class="link-text">Tools</span>
                    </a>
                </li>

                <li>
                    <div class="sidebar-divider"></div>
                </li>

                <!-- How It Works -->
                <li class="sidebar-item">
                    <a class="sidebar-link" href="how-it-works.html">
                        <span class="link-icon">üí°</span>
                        <span class="link-text">How It Works</span>
                    </a>
                </li>

                <!-- Support Tickets -->
                <li class="sidebar-item">
                    <a class="sidebar-link" data-section="support" onclick="navigateTo('support', this)">
                        <span class="link-icon">üé´</span>
                        <span class="link-text">Support Tickets</span>
                    </a>
                </li>

                <!-- Master (expandable) -->
                <li class="sidebar-item">
                    <a class="sidebar-link" onclick="toggleSubmenu(this)">
                        <span class="link-icon">‚öôÔ∏è</span>
                        <span class="link-text">Master</span>
                        <span class="chevron">‚ñ∂</span>
                    </a>
                    <ul class="sidebar-submenu" id="sub-master">
                        <li><a onclick="navigateTo('master-gstin', this)" data-section="master-gstin">GSTIN</a></li>
                        <li><a onclick="navigateTo('master-pan', this)" data-section="master-pan">PAN</a></li>
                        <li><a onclick="navigateTo('master-users', this)" data-section="master-users">User
                                Management</a></li>
                    </ul>
                </li>
            </ul>
        </aside>

        <!-- ===== MAIN CONTENT ===== -->
        <main class="main-content">

            <!-- ========== DASHBOARD ========== -->
            <div class="content-section" id="sec-dashboard">
                <div class="section-header">
                    <h1>üìä Dashboard</h1>
                    <p class="section-subtitle">Overview of your GST compliance status</p>
                </div>
                <div class="refund-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Clients</div>
                        <div class="stat-value">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Refunds</div>
                        <div class="stat-value orange">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Completed</div>
                        <div class="stat-value green">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Notices</div>
                        <div class="stat-value">‚Äî</div>
                    </div>
                </div>
                <p style="color:#9ca3af; text-align:center; margin-top:2rem;">Dashboard analytics coming soon.</p>
            </div>

            <!-- ========== NOTICE MANAGEMENT ========== -->
            <div class="content-section" id="sec-notice">
                <div class="section-header">
                    <h1>üîî Notice Management</h1>
                    <p class="section-subtitle">Track and respond to GST notices efficiently</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">üì≠</div>
                    <h3>No Active Notices</h3>
                    <p>Notices from the GST portal will appear here once synced.</p>
                </div>
            </div>

            <!-- ========== GST REFUND DASHBOARD ========== -->
            <div class="content-section" id="sec-refund-dashboard">
                <div class="section-header">
                    <h1>üí∞ Refund Dashboard</h1>
                    <p class="section-subtitle">Track all your GST refund claims in one place</p>
                </div>
                <div class="refund-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Claims</div>
                        <div class="stat-value">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Amount</div>
                        <div class="stat-value orange">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Approved</div>
                        <div class="stat-value green">‚Äî</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Rejected</div>
                        <div class="stat-value" style="color:#ef4444">‚Äî</div>
                    </div>
                </div>
                <p style="color:#9ca3af; text-align:center; margin-top:2rem;">Detailed refund tracking will be available
                    soon.</p>
            </div>

            <!-- ========== CALCULATE GST REFUND ========== -->
            <div class="content-section" id="sec-calculate-refund">
                <div class="section-header">
                    <h1>üßÆ Calculate GST Refund</h1>
                    <p class="section-subtitle">AI-powered refund amount calculation using Rule 89(4) & 89(5)</p>
                </div>

                <div class="workflow-container">
                    <!-- Step 1: Category Selection -->
                    <div class="wf-step active" id="calc-step-1">
                        <div class="wf-header">
                            <h2>Select Refund Category</h2>
                            <p>Choose the category of refund you want to calculate.</p>
                        </div>
                        <div class="cat-grid">
                            <div class="cat-btn" onclick="selectRefundCategory('goods_lut')">
                                <span class="icon">üö¢</span>
                                <span class="title">Export of Goods</span>
                                <span class="desc">Under LUT - Without payment of tax (Rule 89(4))</span>
                            </div>
                            <div class="cat-btn" onclick="selectRefundCategory('service_lut')">
                                <span class="icon">üßæ</span>
                                <span class="title">Export of Services</span>
                                <span class="desc">Under LUT - Without payment of tax (Rule 89(4))</span>
                            </div>
                            <div class="cat-btn" onclick="selectRefundCategory('inverted')">
                                <span class="icon">‚öñÔ∏è</span>
                                <span class="title">Inverted Duty Structure</span>
                                <span class="desc">Tax rate on inputs > rate on outputs (Rule 89(5))</span>
                            </div>
                            <div class="cat-btn" onclick="selectRefundCategory('deemed')">
                                <span class="icon">üì¶</span>
                                <span class="title">Deemed Exports</span>
                                <span class="desc">Supplies which don't leave the country (Rule 89(4))</span>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Automated File Upload -->
                    <div class="wf-step" id="calc-step-2">
                        <div class="wf-header">
                            <h2 id="input-title">Upload Required Documents</h2>
                            <p id="input-desc">Drag and drop or click to upload the files needed for your refund claim.
                            </p>
                        </div>

                        <div id="upload-grid-wf"
                            style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <!-- Dynamic upload zones will be shown here via JS -->
                        </div>

                        <div class="file-list-wf" id="calc-file-list">
                            <!-- Selected files listed here -->
                        </div>

                        <input type="file" id="calc-file-input" style="display:none" multiple
                            onchange="handleCalcFiles(this)">

                        <div class="wf-footer">
                            <button class="btn-wf btn-wf-outline" onclick="goToStep(1)">‚Üê Back</button>
                            <button class="btn-wf btn-wf-primary" id="btn-process-calc"
                                onclick="triggerBackendCalculation()" disabled>Process Calculation ‚Üí</button>
                        </div>
                    </div>

                    <!-- Step 3: Result & Status -->
                    <div class="wf-step" id="calc-step-3">
                        <div class="wf-header">
                            <h2 id="result-title">Processing Calculation</h2>
                            <p id="result-desc">Extracting data from your documents and computing refund amount...</p>
                        </div>

                        <div id="result-loader" class="result-box pulse" style="margin-bottom: 1.5rem;">
                            <div class="result-label">ANALYZING DOCUMENTS</div>
                            <div class="result-amount">...</div>
                            <div class="formula-hint">This usually takes 15-30 seconds.</div>
                        </div>

                        <div id="result-content" class="result-box" style="display:none; margin-bottom: 1.5rem;">
                            <div class="result-label">MAXIMUM REFUND AMOUNT</div>
                            <div class="result-amount" id="final-amount">‚Çπ 0.00</div>
                            <p id="calc-summary" style="font-size: 0.85rem; color: #64748b; margin-top: 0.5rem;"></p>
                            <div class="formula-hint" id="formula-display">Calculation based on (B * A / C)</div>
                        </div>

                        <div class="wf-footer">
                            <button class="btn-wf btn-wf-outline" onclick="goToStep(2)">‚Üê Edit Uploads</button>
                            <button class="btn-wf btn-wf-primary" onclick="resetCalculator()">Start New ‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== KNOW YOUR GST REFUND ========== -->
            <div class="content-section" id="sec-know-refund">
                <div class="section-header">
                    <h1>üìñ Know Your GST Refund</h1>
                    <p class="section-subtitle">Understand refund eligibility and categories</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">üìö</div>
                    <h3>Knowledge Base</h3>
                    <p>GST refund guides and eligibility criteria will appear here.</p>
                </div>
            </div>

            <!-- ========== TRACK REQUEST ========== -->
            <div class="content-section" id="sec-track-request">
                <div class="section-header">
                    <h1>üìç Track Request</h1>
                    <p class="section-subtitle">Monitor the status of your refund applications</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">üîç</div>
                    <h3>No Active Requests</h3>
                    <p>Submit a refund claim to start tracking its progress here.</p>
                </div>
            </div>

            <!-- ========== GST RETURNS ========== -->
            <div class="content-section" id="sec-gstr1">
                <div class="section-header">
                    <h1>üìã GSTR-1</h1>
                    <p class="section-subtitle">Outward supply return management</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">üìù</div>
                    <h3>GSTR-1 Filing</h3>
                    <p>GSTR-1 management features coming soon.</p>
                </div>
            </div>

            <div class="content-section" id="sec-gstr3b">
                <div class="section-header">
                    <h1>üìã GSTR-3B</h1>
                    <p class="section-subtitle">Summary return management</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">üìù</div>
                    <h3>GSTR-3B Filing</h3>
                    <p>GSTR-3B management features coming soon.</p>
                </div>
            </div>

            <!-- ========== REPORTS ========== -->
            <div class="content-section" id="sec-reports">
                <div class="section-header">
                    <h1>üìÑ Reports</h1>
                    <p class="section-subtitle">Generate and download compliance reports</p>
                </div>
                <div class="report-list">
                    <div class="report-item" onclick="triggerJob('statement3')">
                        <span class="report-icon">üìã</span>
                        <div class="report-info">
                            <div class="report-name">Statement 3 Report</div>
                            <div class="report-desc">Shipping bill reconciliation for export refund</div>
                        </div>
                        <span class="report-arrow">‚Üí</span>
                    </div>
                    <div class="report-item" onclick="triggerJob('annexure_b')">
                        <span class="report-icon">üìë</span>
                        <div class="report-info">
                            <div class="report-name">Annexure B Report</div>
                            <div class="report-desc">ITC details from GSTR-2B for refund application</div>
                        </div>
                        <span class="report-arrow">‚Üí</span>
                    </div>
                    <div class="report-item" onclick="triggerJob('gst_recon')">
                        <span class="report-icon">‚öñÔ∏è</span>
                        <div class="report-info">
                            <div class="report-name">Reconciliation Summary</div>
                            <div class="report-desc">Purchase and sales reconciliation report</div>
                        </div>
                        <span class="report-arrow">‚Üí</span>
                    </div>
                    <div class="report-item" onclick="triggerJob('gst_verify')">
                        <span class="report-icon">‚úÖ</span>
                        <div class="report-info">
                            <div class="report-name">GSTIN Verification Report</div>
                            <div class="report-desc">Verification status of all vendor GSTINs</div>
                        </div>
                        <span class="report-arrow">‚Üí</span>
                    </div>
                </div>
            </div>

            <!-- ========== GST RECONCILIATION (DEFAULT ACTIVE) ========== -->
            <div class="content-section active" id="sec-reconciliation">
                <div class="section-header">
                    <h1>‚öñÔ∏è GST Reconciliations</h1>
                    <p class="section-subtitle">Automated tools for accurate GST compliance</p>
                </div>

                <!-- Purchase Reconciliation -->
                <div class="category-header">
                    <span class="cat-icon">üì¶</span>
                    <h2>Purchase Reconciliation</h2>
                </div>
                <p class="category-subtitle">Tools for ITC (Input Tax Credit) verification and purchase matching</p>

                <div class="cards-grid">
                    <div class="tool-card">
                        <div class="card-top">
                            <div class="card-icon">‚ö°</div>
                            <span class="card-badge">PURCHASE</span>
                        </div>
                        <h3 class="card-title">IMS vs PR</h3>
                        <p class="card-desc">Reconcile Invoice Management System with Purchase Register</p>
                        <a class="card-action" onclick="triggerJob('ims_vs_pr')">Open Tool ‚Üí</a>
                    </div>
                    <div class="tool-card">
                        <div class="card-top">
                            <div class="card-icon">üîÄ</div>
                            <span class="card-badge">PURCHASE</span>
                        </div>
                        <h3 class="card-title">GSTR-2B vs PR</h3>
                        <p class="card-desc">Match GSTR-2B with Purchase Register for ITC verification</p>
                        <a class="card-action" onclick="triggerJob('gstr2b_vs_pr')">Open Tool ‚Üí</a>
                    </div>
                    <div class="tool-card">
                        <div class="card-top">
                            <div class="card-icon">üîó</div>
                            <span class="card-badge">PURCHASE</span>
                        </div>
                        <h3 class="card-title">GSTR-2B vs GSTR-3B</h3>
                        <p class="card-desc">Tax credit reconciliation between 2B and 3B for ITC matching</p>
                        <a class="card-action" onclick="triggerJob('gstr2b_vs_3b')">Open Tool ‚Üí</a>
                    </div>
                </div>

                <!-- Sales Reconciliation -->
                <div class="category-header" style="margin-top:2.5rem;">
                    <span class="cat-icon">üìä</span>
                    <h2>Sales Reconciliation</h2>
                </div>
                <p class="category-subtitle">Tools for sales verification and output tax reconciliation</p>

                <div class="cards-grid">
                    <div class="tool-card">
                        <div class="card-top">
                            <div class="card-icon">üìÑ</div>
                            <span class="card-badge sales">SALES</span>
                        </div>
                        <h3 class="card-title">E-Invoice vs Sales Register</h3>
                        <p class="card-desc">Validate E-Invoices against Sales Register for output tax</p>
                        <a class="card-action" onclick="triggerJob('einv_vs_sales')">Open Tool ‚Üí</a>
                    </div>
                    <div class="tool-card">
                        <div class="card-top">
                            <div class="card-icon">üîÑ</div>
                            <span class="card-badge sales">SALES</span>
                        </div>
                        <h3 class="card-title">GSTR-1 vs E-Invoice</h3>
                        <p class="card-desc">Reconcile GSTR-1 data with E-Invoices for sales verification</p>
                        <a class="card-action" onclick="triggerJob('gstr1_vs_einv')">Open Tool ‚Üí</a>
                    </div>
                    <div class="tool-card">
                        <div class="card-top">
                            <div class="card-icon">üìà</div>
                            <span class="card-badge sales">SALES</span>
                        </div>
                        <h3 class="card-title">GSTR-1 vs GSTR-3B</h3>
                        <p class="card-desc">Outward supply reconciliation between GSTR-1 & 3B for output tax</p>
                        <a class="card-action" onclick="triggerJob('gstr1_vs_3b')">Open Tool ‚Üí</a>
                    </div>
                </div>
            </div>

            <!-- ========== TOOLS ========== -->
            <div class="content-section" id="sec-tools">
                <div class="section-header" style="display:flex; align-items:center; justify-content:space-between;">
                    <div>
                        <h1>‚ò∞ Tools</h1>
                    </div>
                    <div style="position:relative;">
                        <input type="text" id="tools-search" placeholder="Search Tools..."
                            style="padding:0.6rem 1rem 0.6rem 2.25rem; border:1.5px solid #e5e7eb; border-radius:8px; font-size:0.85rem; width:240px; font-family:inherit;"
                            oninput="filterTools(this.value)">
                        <span
                            style="position:absolute; left:0.75rem; top:50%; transform:translateY(-50%); color:#9ca3af; font-size:0.85rem;">üîç</span>
                    </div>
                </div>

                <!-- All Tools Grid -->
                <div class="cards-grid" id="tools-grid">
                    <!-- Refund Tools (Prioritized) -->
                    <div class="tool-card coming-soon-card" data-tool-name="arn status">
                        <div class="coming-soon-tag">Coming Soon</div>
                        <div class="card-top">
                            <div class="card-icon">üìã</div>
                        </div>
                        <h3 class="card-title">ARN Status</h3>
                        <p class="card-desc">Check ARN status with our efficient and quick tool.</p>
                        <a class="card-action">Explore ‚Üí</a>
                    </div>
                    <div class="tool-card" data-tool-name="statement3 generation"
                        onclick="navigateToTool('tool-statement3.html')">
                        <div class="card-top">
                            <div class="card-icon">üìù</div>
                        </div>
                        <h3 class="card-title">Statement3 Generation</h3>
                        <p class="card-desc">Generate your statement 3 from Shipping Bills and BRC documents.</p>
                        <a class="card-action">Explore ‚Üí</a>
                    </div>
                    <div class="tool-card" data-tool-name="annexure b" onclick="navigateToTool('tool-annexure-b.html')">
                        <div class="card-top">
                            <div class="card-icon">üìë</div>
                        </div>
                        <h3 class="card-title">Annexure B</h3>
                        <p class="card-desc">Annexure-B helps streamline GST refund documentation with simplified
                            processing.</p>
                        <a class="card-action">Explore ‚Üí</a>
                    </div>
                    <div class="tool-card" data-tool-name="document reader"
                        onclick="navigateToTool('tool-document-reader.html')">
                        <div class="card-top">
                            <div class="card-icon">üìñ</div>
                        </div>
                        <h3 class="card-title">Document Reader</h3>
                        <p class="card-desc">Extract data from CSB, BRC, Invoice, Shipping Bill, and FIRC.</p>
                        <a class="card-action">Explore ‚Üí</a>
                    </div>

                    <!-- Return Tools -->
                    <div class="tool-card" data-tool-name="gstin validator"
                        onclick="navigateToTool('tool-gstin-validator.html')">
                        <div class="card-top">
                            <div class="card-icon">üîç</div>
                        </div>
                        <h3 class="card-title">GSTIN Validator</h3>
                        <p class="card-desc">Validate GSTINs with our efficient and quick tool.</p>
                        <a class="card-action">Explore ‚Üí</a>
                    </div>
                    <div class="tool-card" data-tool-name="ai block credit"
                        onclick="navigateToTool('tool-ai-block-credit.html')">
                        <div class="card-top">
                            <div class="card-icon">ü§ñ</div>
                        </div>
                        <h3 class="card-title">AI Block Credit</h3>
                        <p class="card-desc">Get your ITC Blocking status and find your HSN based on Purchase and Sales
                            Register</p>
                        <a class="card-action">Explore ‚Üí</a>
                    </div>
                    <div class="tool-card" data-tool-name="hsn plotter"
                        onclick="navigateToTool('tool-hsn-plotter.html')">
                        <div class="card-top">
                            <div class="card-icon">üìä</div>
                        </div>
                        <h3 class="card-title">HSN Plotter</h3>
                        <p class="card-desc">Identify and map HSN codes from your registers for compliance.</p>
                        <a class="card-action">Explore ‚Üí</a>
                    </div>
                    <div class="tool-card coming-soon-card" data-tool-name="gstr-9 json generator">
                        <div class="coming-soon-tag">Coming Soon</div>
                        <div class="card-top">
                            <div class="card-icon">üìÑ</div>
                        </div>
                        <h3 class="card-title">GSTR-9 JSON Generator</h3>
                        <p class="card-desc">Easily generate accurate GSTR-9 JSON files for seamless portal upload.</p>
                        <a class="card-action">Explore ‚Üí</a>
                    </div>
                </div>
            </div>

            <!-- ========== SUPPORT ========== -->
            <div class="content-section" id="sec-support">
                <div class="section-header">
                    <h1>üé´ Support Tickets</h1>
                    <p class="section-subtitle">Get help from our compliance experts</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">üí¨</div>
                    <h3>Need Help?</h3>
                    <p>Create a support ticket and our team will respond within 24 hours.</p>
                </div>
            </div>

            <!-- ========== MASTER SECTIONS ========== -->
            <div class="content-section" id="sec-master-gstin">
                <div class="section-header">
                    <h1>üè¢ GSTIN Management</h1>
                    <p class="section-subtitle">Manage your registered GSTINs</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">üè¢</div>
                    <h3>GSTIN Registry</h3>
                    <p>Your registered GSTINs will appear here.</p>
                </div>
            </div>

            <div class="content-section" id="sec-master-pan">
                <div class="section-header">
                    <h1>ü™™ PAN Management</h1>
                    <p class="section-subtitle">Manage PAN details</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">ü™™</div>
                    <h3>PAN Details</h3>
                    <p>Your PAN records will appear here.</p>
                </div>
            </div>

            <div class="content-section" id="sec-master-users">
                <div class="section-header">
                    <h1>üë• User Management</h1>
                    <p class="section-subtitle">Manage team members and access control</p>
                </div>
                <div class="notice-empty">
                    <div class="empty-icon">üë•</div>
                    <h3>Team Members</h3>
                    <p>User management features coming soon.</p>
                </div>
            </div>

        </main>
    </div>

    <script src="api_config.js?v=2"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId');
        const serviceName = urlParams.get('service');
        const user = JSON.parse(localStorage.getItem('user'));
        let uploadedFiles = [];
        let activeJobs = {};

        // UI Init
        if (user) {
            const initial = (user.firm_name || user.full_name || user.name || 'U').charAt(0).toUpperCase();
            document.getElementById('nav-avatar').textContent = initial;
        }

        document.getElementById('nav-service-name').textContent = serviceName ? serviceName.toUpperCase().replace('-', ' ') : 'GST REFUND';
        document.getElementById('back-btn').href = `services-dashboard.html?clientId=${clientId}`;

        // Section Persistence on Load
        window.addEventListener('load', () => {
            const sectionParam = urlParams.get('section');
            if (sectionParam) {
                // Find the sidebar link corresponding to this section
                const sidebarLink = document.querySelector(`[data-section="${sectionParam}"]`);
                navigateTo(sectionParam, sidebarLink);
            } else {
                // Default to reconciliation if no section specified
                const defaultLink = document.querySelector('[data-section="reconciliation"]');
                navigateTo('reconciliation', defaultLink);
            }
        });

        // Profile Dropdown
        window.toggleProfileDropdown = function (e) {
            e.stopPropagation();
            const dd = document.getElementById('profile-dropdown');
            if (dd) dd.classList.toggle('active');
        }

        document.addEventListener('click', () => {
            const dd = document.getElementById('profile-dropdown');
            if (dd) dd.classList.remove('active');
        });

        window.logout = function () {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // ===== SIDEBAR NAVIGATION =====
        function navigateTo(sectionId, el) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            // Show target section
            const target = document.getElementById('sec-' + sectionId);
            if (target) target.classList.add('active');

            // Update sidebar active state
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelectorAll('.sidebar-submenu li a').forEach(l => l.classList.remove('active'));

            if (el) {
                if (el.closest('.sidebar-submenu')) {
                    el.classList.add('active');
                    // Also highlight parent
                    const parentLink = el.closest('.sidebar-item').querySelector('.sidebar-link');
                    if (parentLink) parentLink.classList.add('active');
                } else {
                    el.classList.add('active');
                }
            }
        }

        function toggleSubmenu(linkEl) {
            const submenu = linkEl.nextElementSibling;
            if (!submenu || !submenu.classList.contains('sidebar-submenu')) return;

            const isOpen = submenu.classList.contains('open');

            // Close all submenus
            document.querySelectorAll('.sidebar-submenu').forEach(s => s.classList.remove('open'));
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('expanded'));

            if (!isOpen) {
                submenu.classList.add('open');
                linkEl.classList.add('expanded');
            }
        }

        // ===== FILE/JOB LOGIC (preserved from original) =====
        loadFiles();
        setInterval(loadFiles, 10000);

        async function loadFiles() {
            if (!clientId) return;
            try {
                const res = await authFetch(`/jobs/?skip=0&limit=50&client_id=${clientId}`);
                if (res.ok) {
                    const jobs = await res.json();
                    activeJobs = jobs;
                    renderReportList(jobs);
                }
            } catch (e) { console.error("Sync error", e); }
        }

        function renderReportList(jobs) {
            const list = document.querySelector('.report-list');
            if (!list) return;

            if (jobs.length === 0) {
                list.innerHTML = '<div class="notice-empty"><p>No reports generated yet.</p></div>';
                return;
            }

            list.innerHTML = jobs.map(job => {
                const date = new Date(job.created_at).toLocaleDateString();
                const jobName = job.job_type.toUpperCase().replace('_', ' ');
                const isCompleted = job.status === 'COMPLETED';

                return `
                    <div class="report-item" onclick="${isCompleted ? `downloadFile('${job.id}')` : `alert('Job is still ${job.status}')`}">
                        <span class="report-icon">${isCompleted ? 'üìÑ' : '‚è≥'}</span>
                        <div class="report-info">
                            <div class="report-name">${jobName} (${job.status})</div>
                            <div class="report-desc">Generated on ${date}</div>
                        </div>
                        <span class="report-arrow">${isCompleted ? '‚Üì' : ''}</span>
                    </div>
                `;
            }).join('');
        }

        async function triggerJob(jobType) {
            if (!clientId) return alert("Client ID missing");

            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.onchange = async (e) => {
                if (e.target.files.length === 0) return;

                const files = Array.from(e.target.files);
                const fileKeys = [];

                try {
                    alert(`Uploading ${files.length} file(s) and starting ${jobType}...`);

                    const uploadPromises = files.map(async (file) => {
                        const formData = new FormData();
                        formData.append('file', file);
                        formData.append('title', file.name);
                        formData.append('scope', 'CLIENT');
                        formData.append('client_id', clientId);

                        const uploadRes = await fetch(`${API_BASE_URL}/jobs/upload`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('access_token')}` },
                            body: formData
                        });

                        if (!uploadRes.ok) throw new Error(`Upload failed for ${file.name}`);
                        const uploadData = await uploadRes.json();
                        return uploadData.file_key || uploadData.file_path;
                    });

                    fileKeys.push(...await Promise.all(uploadPromises));

                    const jobPayload = {
                        job_type: jobType,
                        input_files: fileKeys,
                        client_id: clientId
                    };

                    const jobRes = await authFetch('/jobs/', {
                        method: 'POST',
                        body: JSON.stringify(jobPayload)
                    });

                    if (jobRes.ok) {
                        alert("Job Started Successfully! Check status in a few seconds.");
                        loadFiles();
                    } else {
                        const err = await jobRes.json();
                        alert("Failed to start job: " + err.detail);
                    }

                } catch (err) {
                    console.error(err);
                    alert("Error: " + err.message);
                }
            };
            input.click();
        }

        async function downloadFile(jobId) {
            try {
                const response = await authFetch(`/jobs/${jobId}/download`);
                if (!response.ok) {
                    alert('Download failed: ' + response.statusText);
                    return;
                }

                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'report.xlsx';
                if (contentDisposition) {
                    const match = contentDisposition.match(/filename="?(.+)"?/);
                    if (match && match[1]) filename = match[1];
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (e) {
                console.error('Download error:', e);
                alert('Error downloading file');
            }
        }

        /* ===== TOOLS NAVIGATION ===== */
        function navigateToTool(page) {
            const params = new URLSearchParams(window.location.search);
            window.location.href = page + '?' + params.toString();
        }

        /* ===== CALCULATE GST REFUND LOGIC (FILE-DRIVEN) ===== */
        let currentCalcCategory = '';
        let selectedCalcFiles = {}; // { zoneId: File }
        let currentTargetZone = '';

        const calcConfigs = {
            goods_lut: {
                title: "Export of Goods (LUT)",
                desc: "Upload Shipping Bills, Purchase Register, and GSTR-2B.",
                zones: [
                    { id: 'sb', label: 'Shipping Bills', icon: 'üö¢', sub: 'Excel with SB details' },
                    { id: 'pr', label: 'Purchase Register', icon: 'üì•', sub: 'Input invoices data' },
                    { id: '2b', label: 'GSTR-2B', icon: 'üìã', sub: 'Portal Excel/JSON' }
                ]
            },
            service_lut: {
                title: "Export of Services (LUT)",
                desc: "Upload Invoices, BRC/FIRC, and Purchase Register.",
                zones: [
                    { id: 'inv', label: 'Export Invoices', icon: 'üßæ', sub: 'Excel/PDF invoices' },
                    { id: 'brc', label: 'BRC / FIRC', icon: 'üè¶', sub: 'Realisation certificates' },
                    { id: 'pr', label: 'Purchase Register', icon: 'üì•', sub: 'Input invoices data' }
                ]
            },
            inverted: {
                title: "Inverted Duty Structure",
                desc: "Upload Sales Register, Purchase Register, and GSTR-2B.",
                zones: [
                    { id: 'sr', label: 'Sales Register', icon: 'üì§', sub: 'Inverted supply sales' },
                    { id: 'pr', label: 'Purchase Register', icon: 'üì•', sub: 'Input invoices data' },
                    { id: '2b', label: 'GSTR-2B', icon: 'üìã', sub: 'Portal Excel/JSON' }
                ]
            },
            deemed: {
                title: "Deemed Exports",
                desc: "Upload Invoices and Proof of Receipt.",
                zones: [
                    { id: 'inv', label: 'Tax Invoices', icon: 'üì¶', sub: 'Deemed export invoices' },
                    { id: 'proof', label: 'Proof of Receipt', icon: '‚úÖ', sub: 'Signed acknowledgement' }
                ]
            }
        };

        function selectRefundCategory(cat) {
            currentCalcCategory = cat;
            selectedCalcFiles = {};
            const config = calcConfigs[cat];

            document.getElementById('input-title').textContent = config.title;
            document.getElementById('input-desc').textContent = config.desc;

            const grid = document.getElementById('upload-grid-wf');
            grid.innerHTML = config.zones.map(z => `
                <div class="upload-zone" onclick="triggerCalcUpload('${z.id}')">
                    <div class="icon">${z.icon}</div>
                    <div class="text"><strong>${z.label}</strong><br><span>${z.sub}</span></div>
                </div>
            `).join('');

            renderCalcFileList();
            goToStep(2);
        }

        function triggerCalcUpload(zoneId) {
            currentTargetZone = zoneId;
            document.getElementById('calc-file-input').click();
        }

        function handleCalcFiles(input) {
            if (input.files.length > 0 && currentTargetZone) {
                selectedCalcFiles[currentTargetZone] = input.files[0];
                renderCalcFileList();
                input.value = ''; // Reset input for same file upload

                // Enable button if all required zones have files (or at least one for flexibility)
                const config = calcConfigs[currentCalcCategory];
                const btn = document.getElementById('btn-process-calc');
                btn.disabled = Object.keys(selectedCalcFiles).length < config.zones.length;
            }
        }

        function removeCalcFile(zoneId) {
            delete selectedCalcFiles[zoneId];
            renderCalcFileList();
            document.getElementById('btn-process-calc').disabled = true;
        }

        function renderCalcFileList() {
            const list = document.getElementById('calc-file-list');
            const config = calcConfigs[currentCalcCategory];
            if (!config) return;

            let html = '';
            config.zones.forEach(z => {
                if (selectedCalcFiles[z.id]) {
                    html += `
                        <div class="file-item-wf">
                            <span class="name">${z.icon} ${z.label}: ${selectedCalcFiles[z.id].name}</span>
                            <span class="remove" onclick="removeCalcFile('${z.id}')">‚úï</span>
                        </div>
                    `;
                }
            });
            list.innerHTML = html;
        }

        function goToStep(step) {
            document.querySelectorAll('.wf-step').forEach(s => s.classList.remove('active'));
            document.getElementById(`calc-step-${step}`).classList.add('active');
        }

        async function triggerBackendCalculation() {
            const btn = document.getElementById('btn-process-calc');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Processing...';

            goToStep(3);
            document.getElementById('result-loader').style.display = 'block';
            document.getElementById('result-content').style.display = 'none';

            try {
                const token = localStorage.getItem('access_token');
                const fileKeys = [];
                const filesToUpload = Object.values(selectedCalcFiles);

                for (const file of filesToUpload) {
                    const fd = new FormData();
                    fd.append('file', file);
                    fd.append('client_id', clientId);
                    fd.append('scope', 'CLIENT');

                    const res = await fetch(`${API_BASE_URL}/jobs/upload`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` },
                        body: fd
                    });
                    if (res.ok) {
                        const d = await res.json();
                        fileKeys.push(d.file_key || d.file_path);
                    }
                }

                const jobRes = await fetch(`${API_BASE_URL}/jobs/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_type: 'gst_refund_calc',
                        input_files: fileKeys,
                        client_id: parseInt(clientId),
                        metadata: { refund_type: currentCalcCategory }
                    })
                });

                if (jobRes.ok) {
                    const jobData = await jobRes.json();
                    // Poll for job status or just show success msg
                    document.getElementById('result-title').textContent = "Calculation Started";
                    document.getElementById('result-desc').textContent = "Your documents are being processed. Analysis will be available in the dashboard soon.";

                    // Simulate completion for UI demo (since real polling depends on backend speed)
                    setTimeout(() => {
                        showDemoResult();
                    }, 3000);

                } else {
                    const err = await jobRes.json();
                    alert('Failed to start calculation: ' + (err.detail || 'Error'));
                    goToStep(2);
                }
            } catch (err) {
                console.error(err);
                alert('Error: ' + err.message);
                goToStep(2);
            } finally {
                btn.innerHTML = 'Process Calculation ‚Üí';
            }
        }

        function showDemoResult() {
            document.getElementById('result-loader').style.display = 'none';
            document.getElementById('result-content').style.display = 'block';
            document.getElementById('result-title').textContent = "Calculation Complete";
            document.getElementById('result-desc').textContent = "The maximum refund amount has been computed based on Rule 89.";

            // Random-ish realistic numbers for demo if not using real polling
            document.getElementById('final-amount').textContent = "‚Çπ 1,24,500.00";
            document.getElementById('calc-summary').textContent = "Verified turnovers across all registers and reconciled with GSTR-2B ITC.";
            document.getElementById('formula-display').textContent = currentCalcCategory === 'inverted' ? "Rule 89(5) applied" : "Rule 89(4) applied";
        }

        function resetCalculator() {
            selectedCalcFiles = {};
            currentCalcCategory = '';
            goToStep(1);
        }

        function filterTools(query) {
            const q = query.toLowerCase().trim();
            document.querySelectorAll('#sec-tools .tool-card').forEach(card => {
                const name = (card.getAttribute('data-tool-name') || '').toLowerCase();
                const title = (card.querySelector('.card-title')?.textContent || '').toLowerCase();
                card.style.display = (name.includes(q) || title.includes(q)) ? '' : 'none';
            });
        }
    </script>
</body>

</html>