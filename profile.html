<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - Compliance AI Expert</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
    <style>
        /* Dropdown Styles */
        .navbar-profile {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .nav-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 200px;
            display: none;
            padding: 0.5rem 0;
            z-index: 9999;
            margin-top: 0.5rem;
        }

        .nav-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 0.75rem 1.5rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .dropdown-item:hover {
            background: var(--gray-50);
            color: var(--primary-blue);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--gray-100);
            margin: 0.5rem 0;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="clients.html" class="logo">
                <div class="logo-icon">CE</div>
                <span style="font-weight: 700; color: #1e3a8a;">ComplianceAIexpert</span>
            </a>

            <!-- Center Links -->
            <div style="display: flex; gap: 2rem; margin-left: auto; margin-right: 2rem; align-items: center;">
                <a href="clients.html"
                    style="color: #4B5563; text-decoration: none; font-weight: 500; font-size: 0.95rem;">Home</a>
                <a href="clients.html"
                    style="color: #4B5563; text-decoration: none; font-weight: 500; font-size: 0.95rem;">Clients</a>
                <a href="ai-gpt.html"
                    style="color: #4B5563; text-decoration: none; font-weight: 500; font-size: 0.95rem;">
                    AI GPT <span
                        style="background: #E0E7FF; color: #4338CA; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; margin-left: 0.25rem;">NEW</span>
                </a>
            </div>
            <div class="navbar-profile" onclick="toggleProfileDropdown(event)">
                <div style="display:flex; align-items:center; gap:0.75rem">
                    <div class="user-avatar-small" id="nav-avatar">U</div>
                </div>
                <!-- Dropdown Menu -->
                <div class="nav-dropdown" id="profile-dropdown">
                    <a href="profile.html" class="dropdown-item">
                        <span>ðŸ‘¤</span> My Profile
                    </a>
                    <a href="integrations.html" class="dropdown-item">
                        <span>ðŸ”Œ</span> Integrations
                    </a>
                    <div class="dropdown-divider"></div>
                    <div onclick="logout()" class="dropdown-item" style="color: #EF4444;">
                        <span>ðŸšª</span> Logout
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="profile-container">
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar-wrapper">
                <div class="profile-avatar" id="header-avatar-placeholder"
                    style="display: flex; align-items: center; justify-content: center; font-size: 3rem; font-weight: bold; color: var(--gray-500); background: white;">
                    U</div>
            </div>
            <h1 class="profile-name" id="profile-name">Loading...</h1>
            <p class="profile-role" id="profile-role">Chartered Accountant</p>
            <button class="btn btn-primary" onclick="openEditModal()">Edit Profile</button>
        </div>

        <div class="profile-grid">
            <!-- Subscription Card -->
            <div class="profile-card">
                <div class="profile-card-header">
                    <h3 class="profile-card-title">Subscription: <span
                            style="font-weight: 400; color: var(--gray-600);">Active - Pro Annual</span></h3>
                    <a href="#" style="font-size: 0.875rem; font-weight: 600;">Manage ></a>
                </div>

                <div class="subscription-status">
                    <div class="subscription-badge">
                        <span>âœ“</span> Subscription: Active - Pro Annual
                    </div>
                </div>

                <div style="margin-top: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem;">
                        <span>Active - Pro Annual</span>
                        <span>8 / 10</span>
                    </div>
                    <div class="usage-bar-container">
                        <div class="usage-bar-fill" style="width: 80%;"></div>
                    </div>
                    <p style="font-size: 0.875rem; color: var(--gray-500);">8 / 10 Client Slots Used</p>
                </div>
            </div>

            <!-- Basic Details Card -->
            <div class="profile-card">
                <div class="profile-card-header">
                    <h3 class="profile-card-title">Basic Details</h3>
                </div>

                <div class="info-row">
                    <span class="info-label">Email</span>
                    <span class="info-value" id="detail-email">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Phone</span>
                    <span class="info-value" id="detail-phone">+91 9320 332 532</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Firm Name</span>
                    <span class="info-value" id="detail-firm">Bhatia & Associates</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Team Role</span>
                    <span class="info-value" id="detail-role">Admin</span>
                </div>
            </div>

            <!-- Linked Apps Card -->
            <div class="profile-card">
                <div class="profile-card-header">
                    <h3 class="profile-card-title">Linked Apps</h3>
                </div>

                <div class="linked-app">
                    <span style="font-weight: 700; font-size: 1.25rem; font-style: italic; color: #8B5CF6;">Tally</span>
                    <button class="btn btn-primary btn-small"
                        style="background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark)); box-shadow: none;">+
                        Disconnect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal-overlay"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div class="modal-content"
            style="background: white; padding: 2rem; border-radius: 12px; width: 400px; max-width: 90%;">
            <h2 style="margin-top: 0; margin-bottom: 1.5rem; color: var(--gray-800);">Edit Profile</h2>

            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">Full
                    Name</label>
                <input type="text" id="edit-name" class="form-input"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">Email</label>
                <input type="email" id="edit-email" class="form-input"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">Firm
                    Name</label>
                <input type="text" id="edit-firm-input" class="form-input"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1rem;">
                <label
                    style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">Phone
                    Number</label>
                <input type="text" id="edit-phone" class="form-input"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label
                    style="display: block; font-size: 0.875rem; font-weight: 500; color: var(--gray-700); margin-bottom: 0.5rem;">Job
                    Title</label>
                <input type="text" id="edit-job-title" class="form-input"
                    style="width: 100%; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px;">
            </div>

            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button onclick="closeEditModal()"
                    style="padding: 0.75rem 1.5rem; background: white; border: 1px solid var(--gray-300); border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--gray-700);">Cancel</button>
                <button onclick="saveProfile()"
                    style="padding: 0.75rem 1.5rem; background: var(--primary-blue); border: none; border-radius: 6px; cursor: pointer; font-weight: 600; color: white;">Save
                    Changes</button>
            </div>
        </div>
    </div>

    <script src="api_config.js?v=2"></script>
    <script>
        // Check Auth
        const user = JSON.parse(localStorage.getItem('user'));
        if (!user) window.location.href = 'index.html';

        // Update UI
        const name = user.full_name || user.name || 'User';
        document.getElementById('profile-name').textContent = name;

        const initials = (user.firm_name || name).charAt(0).toUpperCase();
        document.getElementById('nav-avatar').textContent = initials;
        document.getElementById('header-avatar-placeholder').textContent = initials;

        document.getElementById('detail-email').textContent = user.email || user.username || user.id || '';
        document.getElementById('detail-phone').textContent = user.phone_number || '';
        document.getElementById('detail-firm').textContent = user.firm_name || '';
        document.getElementById('profile-role').textContent = user.job_title || user.role || 'Staff';
        document.getElementById('detail-role').textContent = user.role || '';

        // Subscription
        const plan = user.subscription_plan || 'Free';
        if (document.getElementById('sub-header-status')) document.getElementById('sub-header-status').textContent = plan;
        // Fix for missing element IDs in HTML snippet if any

        // Initialize Global Functions
        window.toggleProfileDropdown = function (e) {
            e.stopPropagation();
            const dd = document.getElementById('profile-dropdown');
            if (dd) dd.classList.toggle('active');
        }

        window.logout = function () {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            const dd = document.getElementById('profile-dropdown');
            if (dd) dd.classList.remove('active');
        });

        // Edit Profile Functions
        window.openEditModal = function () {
            document.getElementById('edit-name').value = user.full_name || user.name || '';
            document.getElementById('edit-email').value = user.email || '';
            document.getElementById('edit-firm-input').value = user.firm_name || '';
            document.getElementById('edit-phone').value = user.phone_number || '';
            document.getElementById('edit-job-title').value = user.job_title || '';
            document.getElementById('edit-profile-modal').style.display = 'flex';
        }

        window.closeEditModal = function () {
            document.getElementById('edit-profile-modal').style.display = 'none';
        }

        window.saveProfile = async function () {
            const newName = document.getElementById('edit-name').value;
            const newEmail = document.getElementById('edit-email').value;
            const newFirm = document.getElementById('edit-firm-input').value;
            const newPhone = document.getElementById('edit-phone').value;
            const newJobTitle = document.getElementById('edit-job-title').value;

            try {
                const response = await authFetch('/auth/me', {
                    method: 'PUT',
                    body: JSON.stringify({
                        full_name: newName,
                        email: newEmail,
                        firm_name: newFirm,
                        phone_number: newPhone,
                        job_title: newJobTitle
                    })
                });

                if (response.ok) {
                    const updatedUser = await response.json();

                    // Update Local Storage
                    user.full_name = updatedUser.full_name;
                    user.email = updatedUser.email;
                    // Backend might not return firm_name in User object effectively if not mapped, 
                    // but we know we updated it, so let's update local state.
                    if (newFirm) user.firm_name = newFirm;

                    user.phone_number = updatedUser.phone_number;
                    user.job_title = updatedUser.job_title;

                    localStorage.setItem('user', JSON.stringify(user));

                    // Update UI immediately
                    const displayName = user.full_name || user.name || 'User';
                    document.getElementById('profile-name').textContent = displayName;
                    document.getElementById('detail-email').textContent = user.email || '';
                    document.getElementById('detail-firm').textContent = user.firm_name || '';
                    document.getElementById('detail-phone').textContent = user.phone_number || '';
                    document.getElementById('profile-role').textContent = user.job_title || user.role || 'Staff';

                    closeEditModal();
                    alert('Profile updated successfully!');
                } else {
                    const err = await response.json();
                    alert('Failed to update profile: ' + (err.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error updating profile:', error);
                alert('An error occurred');
            }
        }
    </script>
</body>

</html>