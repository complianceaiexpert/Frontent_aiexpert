<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Services - Compliance AI Expert</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@700;800&display=swap"
        rel="stylesheet">
    <style>
        /* Apply purple gradient background */
        body {
            background: linear-gradient(135deg, #E0E7FF 0%, #F5F3FF 100%);
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 80px auto;
            padding: 2rem 32px;
        }

        /* Navigation Enhancements */
        .nav-links {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--gray-700);
            text-decoration: none;
            font-weight: 500;
            transition: color var(--transition-base);
        }

        .nav-link:hover {
            color: var(--primary-blue);
        }

        .client-info-nav {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .client-name-text {
            font-weight: 600;
            color: var(--gray-900);
            font-size: 0.875rem;
        }

        .client-type-text {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        /* Dropdown Styles */
        .navbar-profile {
            position: relative;
            cursor: pointer;
        }

        .nav-dropdown {
            position: absolute;
            top: 120%;
            right: 0;
            background: white;
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            width: 200px;
            display: none;
            padding: 0.5rem 0;
            z-index: 9999;
            margin-top: 0.5rem;
        }

        .nav-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 0.75rem 1.5rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            transition: background 0.2s;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .dropdown-item:hover {
            background: var(--gray-50);
            color: var(--primary-blue);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--gray-100);
            margin: 0.5rem 0;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .breadcrumb a {
            color: var(--primary-blue);
            text-decoration: none;
            transition: color var(--transition-base);
        }

        .breadcrumb a:hover {
            color: var(--primary-blue-dark);
        }

        .breadcrumb span:not(:has(a)) {
            color: var(--gray-400);
        }

        /* Page Header */
        .page-header-section {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
            font-family: var(--font-display);
        }

        .page-subtitle {
            font-size: 1rem;
            color: var(--gray-600);
            margin-bottom: 1.5rem;
        }

        .page-description-styled {
            display: grid;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .description-block {
            display: flex;
            gap: 1.25rem;
            padding: 1.75rem;
            background: white;
            border-radius: 12px;
            border-left: 4px solid var(--primary-blue);
            box-shadow: 0 2px 8px -2px rgba(0, 0, 0, 0.08);
        }

        .description-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .description-block h4 {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .description-block p {
            font-size: 0.9375rem;
            color: var(--gray-600);
            line-height: 1.7;
            margin: 0;
        }

        /* Client Details Card */
        .client-details-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 3rem;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.08);
        }

        .client-details-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            justify-content: space-between;
        }

        .client-header-actions {
            display: flex;
            gap: 1rem;
        }

        .client-icon-large {
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .client-main-info {
            flex: 1;
        }

        .client-main-info h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .client-entity-badge {
            display: inline-block;
            background: var(--gray-100);
            color: var(--gray-700);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .client-overview-inline {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.6;
            margin-top: 0.75rem;
            max-width: 600px;
        }

        .client-details-body {
            padding-top: 1.5rem;
        }

        .detail-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .detail-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-value {
            font-size: 1rem;
            color: var(--gray-900);
            font-weight: 500;
            font-family: monospace;
        }

        .client-stats-row {
            display: flex;
            gap: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
        }

        .stat-item-small {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .stat-icon-small {
            font-size: 1.5rem;
        }

        .stat-value-small {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
            line-height: 1;
        }

        .stat-label-small {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        /* Services Section */
        .services-section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .services-section-title h2 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--gray-900);
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }

        /* Enhanced Service Cards */
        .service-box-enhanced {
            background: white;
            border: 1px solid var(--gray-100);
            border-radius: 16px;
            padding: 2rem;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            flex-direction: column;
            min-height: 240px;
        }

        .service-box-enhanced:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-blue-light);
        }

        .service-icon-large {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .service-box-enhanced h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            color: var(--gray-900);
        }

        .service-description {
            font-size: 0.875rem;
            color: var(--gray-600);
            line-height: 1.6;
            flex: 1;
            margin-bottom: 1.5rem;
        }

        .service-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-100);
        }

        .service-action {
            font-size: 0.875rem;
            color: var(--primary-blue);
            font-weight: 600;
        }

        .status-pill {
            font-size: 0.75rem;
            padding: 0.4rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-active {
            background: #E0F2FE;
            color: #0369A1;
        }

        .add-service-box {
            border: 2px dashed var(--gray-200);
            background: transparent;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .add-service-box:hover {
            border-color: var(--primary-blue);
            background: #F0F9FF;
        }

        /* View Mode Information Section */
        .view-mode-info-section {
            margin-top: 4rem;
            padding: 2.5rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.08);
        }

        .info-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .info-header h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .info-header p {
            font-size: 1rem;
            color: var(--gray-600);
        }

        .view-mode-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .view-mode-card {
            padding: 2rem;
            border: 2px solid var(--gray-100);
            border-radius: 12px;
            transition: all var(--transition-base);
        }

        .view-mode-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .view-mode-card h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 1rem;
        }

        .view-mode-description {
            font-size: 0.9375rem;
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 1.5rem;
        }

        .view-mode-features {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .view-mode-features li {
            font-size: 0.875rem;
            color: var(--gray-700);
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray-100);
        }

        .view-mode-features li:last-child {
            border-bottom: none;
        }

        .view-mode-note {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #EFF6FF, #F0F9FF);
            border-radius: 12px;
            border-left: 4px solid var(--primary-blue);
        }

        .note-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .view-mode-note p {
            margin: 0;
            font-size: 0.9375rem;
            color: var(--gray-700);
            line-height: 1.6;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 3rem;
            border-radius: var(--radius-2xl);
            width: 100%;
            max-width: 600px;
            text-align: center;
        }

        .view-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .view-option {
            border: 2px solid var(--gray-200);
            padding: 2rem;
            border-radius: var(--radius-xl);
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .view-option:hover {
            border-color: var(--primary-blue);
            background: var(--gray-50);
        }

        .view-option .icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .view-option h4 {
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
        }

        .view-option p {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .service-selection-list {
            margin-top: 1.5rem;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
        }

        .service-selection-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .service-selection-item:hover {
            background: var(--gray-50);
        }

        .service-selection-item input {
            width: 20px;
            height: 20px;
        }

        .service-info h4 {
            margin: 0;
            font-size: 1rem;
        }

        .service-info p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--gray-500);
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="clients.html" class="logo">
                <div class="logo-icon">CE</div>
                <span style="font-weight: 700; color: #1e3a8a;">ComplianceAIexpert</span>
            </a>

            <!-- Center Links -->
            <div style="display: flex; gap: 2rem; margin-left: auto; margin-right: 2rem; align-items: center;">
                <a href="clients.html"
                    style="color: #4B5563; text-decoration: none; font-weight: 500; font-size: 0.95rem;">Home</a>
                <a href="clients.html"
                    style="color: #4B5563; text-decoration: none; font-weight: 500; font-size: 0.95rem;">Clients</a>
                <a href="ai-gpt.html"
                    style="color: #4B5563; text-decoration: none; font-weight: 500; font-size: 0.95rem;">
                    AI GPT <span
                        style="background: #E0E7FF; color: #4338CA; padding: 0.1rem 0.4rem; border-radius: 4px; font-size: 0.7rem; font-weight: 700; margin-left: 0.25rem;">NEW</span>
                </a>
            </div>

            <div class="navbar-profile" onclick="toggleProfileDropdown(event)">
                <div style="display:flex; align-items:center; gap:0.75rem">
                    <div class="user-avatar-small" id="nav-avatar">U</div>
                </div>
                <!-- Dropdown Menu -->
                <div class="nav-dropdown" id="profile-dropdown">
                    <a href="profile.html" class="dropdown-item">
                        <span>ðŸ‘¤</span> My Profile
                    </a>
                    <a href="integrations.html" class="dropdown-item">
                        <span>ðŸ”Œ</span> Integrations
                    </a>
                    <div class="dropdown-divider"></div>
                    <div onclick="logout()" class="dropdown-item" style="color: #EF4444;">
                        <span>ðŸšª</span> Logout
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Breadcrumb -->
        <div class="breadcrumb">
            <a href="clients.html">Home</a>
            <span>â€º</span>
            <a href="clients.html">Clients</a>
            <span>â€º</span>
            <span id="breadcrumb-client">Client</span>
            <span>â€º</span>
            <span>Services</span>
        </div>

        <!-- Page Header -->
        <div class="page-header-section">
            <h1 class="page-title">Service Dashboard</h1>
            <p class="page-subtitle">Manage compliance services for <span id="subtitle-client-name">your client</span>
            </p>
            <div class="page-description">
                <p>Welcome to your centralized service management hub. This dashboard provides a comprehensive overview
                    of all active compliance services for your client. Each service is powered by AI-driven automation,
                    intelligent error detection, and real-time compliance monitoring to ensure accuracy and regulatory
                    adherence.</p>
                <p>Click on any service card below to access detailed workflows, upload documents, track progress, and
                    receive AI-powered recommendations. Our platform combines professional-grade compliance tools with
                    intelligent assistance to streamline your workflow and minimize compliance risks.</p>
            </div>
        </div>

        <!-- Client Details Card -->
        <div class="client-details-card">
            <div class="client-details-header">
                <div class="client-icon-large" id="client-icon-large">C</div>
                <div class="client-main-info">
                    <h2 id="client-details-name">Loading...</h2>
                    <span class="client-entity-badge" id="client-entity-type">Individual</span>
                    <p class="client-overview-inline">GSTIN: <span id="client-gstin">-</span> â€¢ PAN: <span
                            id="client-pan">-</span> â€¢ CIN: <span id="client-cin">-</span></p>
                </div>

                <!-- Right: Actions -->
                <div class="client-header-actions">
                    <button class="btn btn-secondary" onclick="openSyncModal()">
                        <span style="color: #F59E0B; font-weight: 900;">T</span> Sync Tally Data
                    </button>
                </div>
            </div>

            <div class="client-details-body">
                <div class="detail-row">
                    <div class="detail-item">
                        <span class="detail-label">GSTIN</span>
                        <span class="detail-value" id="client-gstin">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">PAN</span>
                        <span class="detail-value" id="client-pan">-</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">CIN</span>
                        <span class="detail-value" id="client-cin">-</span>
                    </div>
                </div>

                <div class="client-stats-row">
                    <div class="stat-item-small">
                        <span class="stat-icon-small">ðŸ“Š</span>
                        <div>
                            <div class="stat-value-small" id="active-services-count">0</div>
                            <div class="stat-label-small">Active Services</div>
                        </div>
                    </div>
                    <div class="stat-item-small">
                        <span class="stat-icon-small">ðŸ“…</span>
                        <div>
                            <div class="stat-value-small" id="last-updated">Today</div>
                            <div class="stat-label-small">Last Updated</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="services-section-title">
            <h2>Available Services</h2>
            <button class="btn btn-primary" onclick="showAddService()">+ Add New Service</button>
        </div>

        <div id="services-grid" class="services-grid">
            <!-- Services loaded here -->
        </div>

        <!-- View Mode Information Section -->
        <div class="view-mode-info-section">
            <div class="info-header">
                <h3>ðŸ“± Choose Your Workspace Experience</h3>
                <p>Select the view that best suits your workflow when accessing any service</p>
            </div>

            <div class="view-mode-cards">
                <div class="view-mode-card">
                    <div class="view-mode-icon">ðŸ’¼</div>
                    <h4>Web View (Professional Mode)</h4>
                    <p class="view-mode-description">
                        A structured, traditional interface designed for professionals who prefer organized checklists,
                        detailed forms, and panel-based workflows. Perfect for accountants and compliance officers who
                        need comprehensive control and visibility over every step of the process.
                    </p>
                    <ul class="view-mode-features">
                        <li>âœ“ Structured checklists and step-by-step workflows</li>
                        <li>âœ“ Multi-panel interface with detailed forms</li>
                        <li>âœ“ Complete data visibility and control</li>
                        <li>âœ“ Ideal for complex compliance tasks</li>
                    </ul>
                </div>

                <div class="view-mode-card">
                    <div class="view-mode-icon">ðŸ’¬</div>
                    <h4>AI Expert View (Guided Mode)</h4>
                    <p class="view-mode-description">
                        An intelligent, conversational interface powered by AI that guides you through compliance tasks
                        with natural language interactions. The AI assistant asks relevant questions, provides
                        contextual
                        help, and simplifies complex processes into easy-to-understand conversations.
                    </p>
                    <ul class="view-mode-features">
                        <li>âœ“ Conversational AI-guided assistance</li>
                        <li>âœ“ Simplified, question-based workflow</li>
                        <li>âœ“ Contextual help and smart suggestions</li>
                        <li>âœ“ Perfect for quick tasks and beginners</li>
                    </ul>
                </div>
            </div>

            <div class="view-mode-note">
                <span class="note-icon">ðŸ’¡</span>
                <p><strong>Pro Tip:</strong> You can switch between views at any time during your work. Choose Web View
                    for detailed control or AI Expert View for guided simplicity.</p>
            </div>
        </div>
    </div>

    <!-- View Selection Modal -->
    <div id="view-modal" class="modal">
        <div class="modal-content">
            <h2 id="view-modal-title">Select Your Workspace</h2>
            <p>How would you like to process this service?</p>

            <div class="view-options">
                <div class="view-option" onclick="navigateToView('web')">
                    <div class="icon">ðŸ’¼</div>
                    <h4>Web View</h4>
                    <p>Professional Mode: Structured checklists & panels</p>
                </div>
                <div class="view-option" onclick="navigateToView('chat')">
                    <div class="icon">ðŸ’¬</div>
                    <h4>AI Expert View</h4>
                    <p>Guided Simplicity: Conversational AI assistance</p>
                </div>
            </div>

            <button class="btn btn-secondary" style="margin-top: 2rem;"
                onclick="closeModal('view-modal')">Cancel</button>
        </div>
    </div>

    <!-- Manage Services Modal -->
    <div id="manage-services-modal" class="modal">
        <div class="modal-content">
            <h2>Add/Manage Services</h2>
            <p>Select the services you want to activate for this client.</p>

            <div id="available-services-list" class="service-selection-list">
                <!-- Loaded via JS -->
            </div>

            <div class="modal-actions" style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('manage-services-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveServices()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Tally Sync Modal -->
    <div id="tally-sync-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-bottom: 0.5rem;">Select Tally Company</h2>
            <p style="color: var(--gray-600); margin-bottom: 1.5rem;">Which open company belongs to <strong><span
                        id="tally-client-target">this client</span></strong>?</p>

            <div id="company-loading" style="display:none; color: var(--primary-blue);">
                Parsing open companies from Tally...
            </div>

            <div id="tally-company-list" class="company-list-container">
                <!-- Items injected by JS -->
            </div>

            <div class="modal-actions" style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('tally-sync-modal')">Cancel</button>
                <button class="btn btn-primary" id="btn-confirm-sync" disabled onclick="confirmSync()">Sync
                    Selected</button>
            </div>
        </div>
    </div>

    <script src="api_config.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const clientId = urlParams.get('clientId');
        let currentService = null;
        let allServices = [];
        let clientServices = [];
        let currentClientData = null; // Store full client object
        const user = JSON.parse(localStorage.getItem('user'));

        if (!clientId) window.location.href = 'clients.html';

        async function loadDashboard() {
            await Promise.all([loadClientInfo(), loadAvailableServices()]);
        }

        async function loadClientInfo() {
            try {
                const response = await authFetch(`/clients/${clientId}`);
                if (!response) return;
                if (!response.ok) throw new Error(`Failed to load client (${response.status})`);

                const client = await response.json();
                currentClientData = client; // Store globally

                // Update all client info displays
                const clientName = client.name;

                // Update Modal Text
                const modalTarget = document.getElementById('tally-client-target');
                if (modalTarget) modalTarget.textContent = clientName;

                const initial = clientName.charAt(0).toUpperCase();
                const isCompany = clientName.toLowerCase().includes('ltd') || clientName.toLowerCase().includes('inc');
                const entityType = isCompany ? 'Private Limited' : 'Individual / Proprietor';

                // Navigation
                const userInitial = (user.firm_name || user.full_name || user.name || 'U').charAt(0).toUpperCase();
                document.getElementById('nav-avatar').textContent = userInitial;

                // Breadcrumb and subtitle
                document.getElementById('breadcrumb-client').textContent = clientName;
                document.getElementById('subtitle-client-name').textContent = clientName;

                // Client Details Card
                document.getElementById('client-details-name').textContent = clientName;
                document.getElementById('client-entity-type').textContent = entityType;
                document.getElementById('client-icon-large').textContent = initial;

                // IDs
                document.getElementById('client-gstin').textContent = (client.gstins && client.gstins[0]) || '-';
                document.getElementById('client-pan').textContent = client.pan || '-';
                document.getElementById('client-cin').textContent = client.cin || '-';

                clientServices = client.services || [];
                document.getElementById('active-services-count').textContent = clientServices.length;

                renderActiveServices();
            } catch (err) {
                console.error('Client Load Error:', err);
                if (err.message.includes('401')) {
                    alert('Session expired. Please sign in again.');
                    window.location.href = 'index.html';
                } else if (err.message.includes('404')) {
                    alert('Client not found.');
                    window.location.href = 'clients.html';
                } else {
                    alert(`Error loading client: ${err.message}`);
                }
            }
        }

        async function loadAvailableServices() {
            try {
                const response = await authFetch('/services/');
                if (response.ok) {
                    allServices = await response.json();
                }
            } catch (err) {
                console.error('Error fetching service templates:', err);
            }
        }

        function navigateToView(viewType) {
            if (!currentService) return;

            let webPage = 'web-view.html';
            let chatPage = 'service-gst-refund.html';

            if (currentService.name.includes('Income Tax')) {
                webPage = 'web-view-income-tax.html';
                chatPage = 'service-income-tax.html';
            } else if (currentService.name.includes('Audit')) {
                webPage = 'web-view-audit.html';
                chatPage = 'service-audit.html';
            }

            const page = viewType === 'web' ? webPage : chatPage;
            // Add view param for chat just in case
            const viewParam = viewType === 'chat' ? '&view=semi-chat' : '';

            window.location.href = `${page}?clientId=${clientId}&serviceId=${currentService.id}${viewParam}`;
        }

        function renderActiveServices() {
            const grid = document.getElementById('services-grid');
            grid.innerHTML = '';

            const serviceData = {
                'GST Refund': {
                    icon: 'ðŸ§¾',
                    desc: 'GST return filing (GSTR-1, GSTR-3B) with automated reconciliation, ITC optimization, and AI-powered error detection for maximum refunds.'
                },
                'GST Filing': {
                    icon: 'ðŸ§¾',
                    desc: 'GST return filing (GSTR-1, GSTR-3B) with automated reconciliation, ITC optimization, and AI-powered error detection for maximum refunds.'
                },
                'Invoice': {
                    icon: 'ðŸ“',
                    desc: 'Professional invoice generation and management system. Create GST-compliant invoices, track payments, manage receivables, and automate invoice delivery. Features include customizable templates, multi-currency support, recurring invoices, and real-time payment tracking with automated reminders.'
                },
                'Taxation': {
                    icon: 'ðŸ“Š',
                    desc: 'Comprehensive tax planning and advisory services covering direct and indirect taxes. Includes tax structure optimization, investment planning for tax efficiency, capital gains management, and strategic tax advisory. Our AI-powered tax calculator provides scenario analysis and recommendations for minimizing tax liability while ensuring full compliance.'
                },
                'Income Tax': {
                    icon: 'ðŸ’°',
                    desc: 'End-to-end Income Tax Return (ITR) filing service for individuals, businesses, and corporations. Covers all ITR forms (ITR-1 to ITR-7) with intelligent tax planning strategies, advance tax calculations, TDS reconciliation, and Form 26AS verification. Our AI-powered deduction optimizer analyzes your financial data to identify all eligible deductions under Section 80C, 80D, and other provisions. Includes assessment support, notice handling, and tax-saving recommendations tailored to your income profile.'
                },
                'Audit': {
                    icon: 'ðŸ”',
                    desc: 'Professional audit services including Statutory Audit, Internal Audit, Tax Audit (44AB), GST Audit, and Stock Audit. Our comprehensive audit framework includes detailed financial statement verification, risk assessment, internal control evaluation, and regulatory compliance checks. AI-powered anomaly detection identifies unusual transactions, potential fraud indicators, and compliance gaps. Deliverables include detailed audit reports, management letters, and actionable recommendations for process improvements and risk mitigation.'
                },
                'Payroll': {
                    icon: 'ðŸ‘¥',
                    desc: 'Complete payroll processing and compliance management solution. Handles salary calculations, statutory deductions (PF, ESI, PT), TDS computation, Form 16 generation, and employee self-service portal access. Automated compliance with labor laws including minimum wages, overtime calculations, and leave management. Features include attendance integration, reimbursement processing, loan management, and real-time payroll reports. Our system ensures timely PF/ESI challans, TDS returns, and complete audit trail for all payroll transactions.'
                },
                'Company Law': {
                    icon: 'ðŸ“‹',
                    desc: 'Comprehensive corporate compliance services under the Companies Act 2013. Includes ROC filings (AOC-4, MGT-7, ADT-1), board meeting management, director appointments/resignations (DIR-12, DIR-11), share capital alterations, and annual compliance calendar. Our platform automates statutory registers, generates board resolutions, tracks filing deadlines, and ensures complete MCA compliance. Services cover incorporation, name changes, registered office shifts, winding up procedures, and all event-based filings with real-time status tracking.'
                },
                'Accounting': {
                    icon: 'ðŸ“Š',
                    desc: 'Professional bookkeeping and accounting services with real-time financial visibility. Includes day-to-day transaction recording, bank reconciliation, accounts payable/receivable management, and financial statement preparation (P&L, Balance Sheet, Cash Flow). Our platform generates comprehensive MIS reports, ratio analysis, budgeting tools, and variance analysis. AI-powered insights identify cost-saving opportunities, cash flow optimization strategies, and financial health indicators. Features include multi-currency support, inventory accounting, and automated financial dashboards.'
                },
                'Compliance': {
                    icon: 'âš–ï¸',
                    desc: 'Unified regulatory compliance management across all applicable laws and regulations. Covers labor law compliance, environmental clearances, FSSAI licenses, trade licenses, professional tax, and industry-specific regulations. Our intelligent compliance calendar tracks all statutory deadlines, sends proactive alerts, and maintains a complete audit trail of all filings. Multi-jurisdiction support ensures compliance across different states and regulatory bodies. Includes license renewal management, inspection readiness, and automated compliance reporting.'
                }
            };

            clientServices.forEach(service => {
                const data = serviceData[service.name] || { icon: 'ðŸ“¦', desc: 'Professional service management' };
                const box = document.createElement('div');
                box.className = 'service-box-enhanced';
                box.onclick = () => openViewSelection(service);

                box.innerHTML = `
                    <div class="service-icon-large">${data.icon}</div>
                    <h3>${service.name}</h3>
                    <p class="service-description">${data.desc}</p>
                    <div class="service-footer">
                        <span class="status-pill status-active">Active</span>
                        <span class="service-action">View Details â†’</span>
                    </div>
                `;
                grid.appendChild(box);
            });

            // Add "Add Service" box
            const addBox = document.createElement('div');
            addBox.className = 'service-box-enhanced add-service-box';
            addBox.onclick = showAddService;
            addBox.innerHTML = `
                <div class="service-icon-large">+</div>
                <h3>Add Service</h3>
                <p class="service-description">Activate additional compliance services</p>
            `;
            grid.appendChild(addBox);
        }

        function openViewSelection(service) {
            currentService = service;
            // Show view selection modal for all services
            const clientName = document.getElementById('client-details-name').textContent;
            document.getElementById('view-modal-title').textContent = `${service.name} for ${clientName}`;
            document.getElementById('view-modal').classList.add('active');
        }

        window.toggleProfileDropdown = function (e) {
            e.stopPropagation();
            const dd = document.getElementById('profile-dropdown');
            if (dd) dd.classList.toggle('active');
        }

        window.logout = function () {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
            const dd = document.getElementById('profile-dropdown');
            if (dd) dd.classList.remove('active');
        });



        function showAddService() {
            const list = document.getElementById('available-services-list');
            list.innerHTML = '';

            allServices.forEach(service => {
                const isChecked = clientServices.some(s => s.id === service.id);
                const isDisabled = service.name !== 'GST Refund';

                const item = document.createElement('div');
                item.className = 'service-selection-item';

                if (isDisabled) {
                    item.style.opacity = '0.6';
                    item.style.cursor = 'not-allowed';
                    item.style.background = '#f9fafb';
                } else {
                    item.onclick = () => {
                        const cb = item.querySelector('input');
                        cb.checked = !cb.checked;
                    };
                }

                item.innerHTML = `
                    <input type="checkbox" data-id="${service.id}" ${isChecked ? 'checked' : ''} ${isDisabled ? 'disabled' : ''} onclick="event.stopPropagation()">
                    <div class="service-info">
                        <h4 style="display:flex; justify-content:space-between; width:100%">
                            ${service.name} 
                            ${isDisabled ? '<span style="font-size:0.7rem; background:#eee; color:#666; padding:2px 6px; border-radius:4px">Coming Soon</span>' : ''}
                        </h4>
                        <p>${service.description || ''}</p>
                    </div>
                `;
                list.appendChild(item);
            });

            document.getElementById('manage-services-modal').classList.add('active');
        }

        async function saveServices() {
            const checkboxes = document.querySelectorAll('#available-services-list input[type="checkbox"]');
            const selectedIds = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.dataset.id);

            try {
                const response = await authFetch(`/clients/${clientId}/services`, {
                    method: 'PUT',
                    body: JSON.stringify({ service_ids: selectedIds })
                });

                if (response.ok) {
                    closeModal('manage-services-modal');
                    await loadClientInfo();
                } else {
                    alert('Failed to update services.');
                }
            } catch (err) {
                console.error(err);
                alert('Connection error while updating services.');
            }
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function selectView(viewType) {
            // Requirement 3: Web View or Semi Chat View
            if (viewType === 'web') {
                window.location.href = `service-gst-refund.html?clientId=${clientId}&view=web`;
            } else {
                window.location.href = `service-gst-refund.html?clientId=${clientId}&view=semi-chat`;
            }
        }

        // --- Tally Sync Functions ---
        let selectedCompany = null;

        async function openSyncModal() {
            const modal = document.getElementById('tally-sync-modal');
            modal.classList.add('active');

            const listContainer = document.getElementById('tally-company-list');
            const loading = document.getElementById('company-loading');

            listContainer.innerHTML = '';
            loading.style.display = 'block';

            try {
                // Fetch from Backend
                const response = await fetch('/tally/companies'); // Relative path to frontend_server
                const companies = await response.json();

                loading.style.display = 'none';

                if (!Array.isArray(companies) || companies.length === 0) {
                    listContainer.innerHTML = '<div style="padding:1rem">No open companies found in Tally (Port 9000).</div>';
                    return;
                }

                companies.forEach(comp => {
                    const div = document.createElement('div');
                    div.className = 'company-item';
                    div.innerHTML = `<span class="company-icon">T</span> <span>${comp}</span>`;
                    div.onclick = () => selectCompany(div, comp);
                    listContainer.appendChild(div);
                });

            } catch (e) {
                loading.style.display = 'none';
                listContainer.innerHTML = '<div style="padding:1rem; color:red">Error connecting to Tally. Is it running?</div>';
                console.error(e);
            }
        }

        function selectCompany(el, name) {
            // Deselect all
            document.querySelectorAll('.company-item').forEach(i => i.classList.remove('selected'));
            // Select this
            el.classList.add('selected');
            selectedCompany = name;
            document.getElementById('btn-confirm-sync').disabled = false;
        }

        async function confirmSync() {
            if (!selectedCompany) return;

            const btn = document.getElementById('btn-confirm-sync');
            const originalText = btn.textContent;
            btn.textContent = 'Syncing...';
            btn.disabled = true;

            try {
                const response = await fetch('/tally/sync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        company_name: selectedCompany,
                        client_id: clientId
                    })
                });
                const res = await response.json();

                closeModal('tally-sync-modal');
                alert(`âœ… Success: ${res.message}\nFile saved locally.`);
                btn.textContent = originalText;

            } catch (e) {
                alert('Sync Failed: ' + e.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        loadDashboard();
    </script>

    <!-- Footer -->
    <footer
        style="background: var(--gray-100); padding: 1.5rem 2rem; text-align: center; border-top: 1px solid var(--gray-200); margin-top: 4rem;">
        <p style="color: var(--gray-600); font-size: 0.875rem; margin: 0;">
            If you need more assistance, write an email to us at
            <a href="mailto:complianceAIExpert@gmail.com"
                style="color: var(--primary-orange); font-weight: 600; text-decoration: none;">complianceAIExpert@gmail.com</a>
        </p>
    </footer>

    <script src="session-manager.js?v=2"></script>
    <script>
        if (!requireAuth()) {
            // Will redirect to login if not authenticated
        }
    </script>
</body>

</html>